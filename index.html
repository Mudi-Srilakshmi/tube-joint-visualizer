<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tube Joint Visualizer (2D)</title>
  <style>
    body{ margin:0; font-family:Arial; display:flex; height:100vh; }
    #toolbar{ width:320px; background:#111; color:#fff; padding:12px; box-sizing:border-box; overflow:auto; }
    #canvasWrap{ flex:1; background:#f3f3f3; position:relative; }
    canvas{ display:block; background:#fff; margin:12px; border:1px solid #ddd; }
    label{ display:block; margin:8px 0 4px; font-size:13px; }
    input, select, button{ width:100%; padding:6px; margin-bottom:8px; box-sizing:border-box; }
    .small{ width:48%; display:inline-block; margin-right:4%; }
    .small:last-child{ margin-right:0 }
  </style>
</head>
<body>
  <div id="toolbar">
    <h3 style="margin:0 0 10px">Tube Visualizer (2D)</h3>

    <label>Tube type</label>
    <select id="tubeType"><option>Rectangular</option><option>Square</option></select>

    <label>Width</label><input id="width" type="number" value="120" />
    <label>Height</label><input id="height" type="number" value="40" />
    <label>Thickness</label><input id="thickness" type="number" value="6" />
    <label>Length</label><input id="length" type="number" value="280" />

    <label>Angle (deg)</label>
    <input id="angle" type="number" value="45" />

    <button id="addBtn">Add Tube</button>
    <button id="snapBtn">Snap angles: 45/90/135 (toggle)</button>
    <button id="wireBtn">Wireframe / Solid</button>
    <button id="undoBtn">Undo</button>
    <button id="exportBtn">Export PNG</button>

    <hr style="border:none;border-top:1px solid #333;margin:10px 0">
    <div id="help" style="font-size:13px;line-height:1.3">
      Controls:<br>
      • Drag: left mouse<br>
      • Rotate: hold <b>R</b> and drag horizontally<br>
      • Delete: select then press <b>Del</b><br>
      • Double-click canvas to add tube at cursor
    </div>
  </div>

  <div id="canvasWrap">
    <canvas id="c" width="1200" height="700"></canvas>
  </div>

<script>
(() => {
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let state = { items: [], selected: null, wire:false, snap:true, history:[] };

function pushHistory(){ state.history.push(JSON.stringify(state.items)); if(state.history.length>50) state.history.shift(); }
document.getElementById('undoBtn').onclick = ()=>{ const last = state.history.pop(); if(last){ state.items = JSON.parse(last); state.selected=null; draw(); } };

function addTube(x=200,y=200){
  const w = +document.getElementById('width').value;
  const h = +document.getElementById('height').value;
  const t = +document.getElementById('thickness').value;
  const len = +document.getElementById('length').value;
  const angle = +document.getElementById('angle').value;
  const id = Date.now() + Math.floor(Math.random()*1000);
  pushHistory();
  state.items.push({id,x,y,w,h,t,len,angle,rot:0});
  draw();
}

document.getElementById('addBtn').onclick = ()=> addTube(300,300);
document.getElementById('wireBtn').onclick = ()=>{ state.wire=!state.wire; draw(); }
document.getElementById('snapBtn').onclick = ()=>{ state.snap=!state.snap; alert('Snap is ' + (state.snap?'ON':'OFF')); }
document.getElementById('exportBtn').onclick = ()=> {
  const link = document.createElement('a');
  link.download = 'tube-assembly.png';
  link.href = canvas.toDataURL();
  link.click();
};

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // grid
  ctx.save();
  ctx.strokeStyle='#eee'; ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<canvas.height;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  ctx.restore();

  state.items.forEach(item=>{
    ctx.save();
    ctx.translate(item.x, item.y);
    ctx.rotate((item.rot+item.angle)*Math.PI/180);
    const L = item.len, H = item.h, T=item.t;
    // draw outer rect centered at origin
    ctx.translate(-L/2, -H/2);
    if(!state.wire){
      ctx.fillStyle='#4c83b6';
      ctx.fillRect(0,0,L,H);
    }
    ctx.strokeStyle='#222'; ctx.lineWidth=1;
    ctx.strokeRect(0,0,L,H);

    // inner hollow
    if(!state.wire){
      ctx.fillStyle='#fff';
      ctx.fillRect(T, T, L-2*T, H-2*T);
    }
    ctx.strokeRect(T,T,L-2*T,H-2*T);

    // selected highlight
    if(state.selected && state.selected.id===item.id){
      ctx.strokeStyle='orange'; ctx.lineWidth=2;
      ctx.strokeRect(0,0,L,H);
    }

    // simple joint preview: if any other is near, show preview square on edge
    state.items.forEach(other=>{
      if(other.id===item.id) return;
      const dx = other.x - item.x, dy = other.y - item.y;
      const dist = Math.hypot(dx,dy);
      if(dist < (L/2 + other.len/2 + 30)){
        ctx.fillStyle='rgba(255,0,0,0.25)';
        ctx.fillRect(L/2 - 12, H/2 - 12, 24, 24);
      }
    });

    ctx.restore();
  });

  ctx.fillStyle='#000'; ctx.font='13px Arial';
  ctx.fillText('Tubes: '+state.items.length, 12, 18);
}

let dragging=false, dragOffset={}, rotating=false, lastX=0;
canvas.onmousedown = (e)=>{
  const mx = e.offsetX, my=e.offsetY;
  for(let i=state.items.length-1;i>=0;i--){
    const it = state.items[i];
    // approximate pick ignoring rotation for simplicity
    if(Math.abs(mx - it.x) < it.len/2 + 10 && Math.abs(my - it.y) < Math.max(it.h,it.w)/2 + 20){
      state.selected = it; dragging=true; dragOffset={dx: mx - it.x, dy: my - it.y}; lastX = e.clientX; draw(); return;
    }
  }
  state.selected = null; draw();
};
canvas.onmousemove = (e)=>{
  if(dragging && state.selected){
    state.selected.x = e.offsetX - dragOffset.dx;
    state.selected.y = e.offsetY - dragOffset.dy;
    draw();
  } else if(rotating && state.selected){
    const dx = e.clientX - lastX;
    state.selected.rot += dx * 0.5;
    lastX = e.clientX;
    if(state.snap){
      const snaps = [0,45,90,135,180,-45,-90];
      let nearest = snaps.reduce((a,b)=> Math.abs(state.selected.rot - a) < Math.abs(state.selected.rot - b) ? a : b);
      state.selected.rot = nearest;
    }
    draw();
  }
};
canvas.onmouseup = (e)=>{ if(dragging) { pushHistory(); } dragging=false; rotating=false; };
canvas.onmouseleave = ()=>{ dragging=false; rotating=false; };

window.addEventListener('keydown', (ev)=>{
  if(ev.key === 'r' || ev.key === 'R'){ if(state.selected){ rotating=true; lastX = event.clientX; } }
  if(ev.key === 'Delete' && state.selected){ pushHistory(); state.items = state.items.filter(i=>i.id!==state.selected.id); state.selected=null; draw(); }
});
window.addEventListener('keyup', (ev)=>{ if(ev.key==='r' || ev.key==='R') rotating=false; });

canvas.ondblclick = (e)=> addTube(e.offsetX, e.offsetY);

// initial demo
addTube(300,200);
addTube(700,300);
draw();
})();
</script>
</body>
</html>
